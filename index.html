<!DOCTYPE html>
<html>
<head>
  <title>Share and View Latest Location</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 60vh; width: 100%; margin-top: 1em; }
    body { font-family: sans-serif; max-width: 600px; margin: auto; }
    #info { margin-top: 0.5em; }
    #sendLocationBtn { margin-top: 1em; padding: 0.5em 1em; }
    #status { margin-top: 0.5em; color: #2a7; }
  </style>
</head>
<body>
  <h2>Share and View Latest Location</h2>
  <button id="sendLocationBtn">Share My Current Location</button>
  <div id="status"></div>
  <div id="map"></div>
  <div id="info">Loading latest location...</div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Your backend endpoint
    const BACKEND_RECEIVE_URL = 'https://location-share-backend-zvu3.onrender.com/receive_location';
    const BACKEND_LATEST_URL = 'https://location-share-backend-zvu3.onrender.com/latest_location';

    let map = L.map('map').setView([0, 0], 2);
    let marker = null;

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    function fetchLocationAndUpdateMap() {
      fetch(BACKEND_LATEST_URL)
        .then(response => {
          if (!response.ok) throw new Error("No location data");
          return response.json();
        })
        .then(data => {
          const { latitude, longitude, timestamp } = data;
          if (!latitude || !longitude) throw new Error("Invalid location data");

          // Update or place marker
          if (marker) {
            marker.setLatLng([latitude, longitude]);
          } else {
            marker = L.marker([latitude, longitude]).addTo(map);
          }
          map.setView([latitude, longitude], 16);

          // Show info
          let timeStr = new Date(timestamp).toLocaleString();
          document.getElementById('info').textContent =
            `Latest Location: Lat ${latitude}, Lon ${longitude} (as of ${timeStr})`;
        })
        .catch(err => {
          document.getElementById('info').textContent =
            'Could not load location: ' + err.message;
        });
    }

    // Initial load
    fetchLocationAndUpdateMap();
    // Refresh every 20 seconds for "real-time" effect
    setInterval(fetchLocationAndUpdateMap, 20000);

    // Handle sending location
    document.getElementById('sendLocationBtn').onclick = function () {
      document.getElementById('status').textContent = "Requesting your location...";
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            document.getElementById('status').textContent = "Sending your location...";
            fetch(BACKEND_RECEIVE_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ latitude: lat, longitude: lon, timestamp: Date.now() })
            })
            .then(res => {
              document.getElementById('status').textContent = "Location sent!";
              // Optionally update map immediately
              fetchLocationAndUpdateMap();
            })
            .catch(err => {
              document.getElementById('status').textContent = "Failed to send location.";
            });
          },
          err => {
            document.getElementById('status').textContent = "Location error: " + err.message;
          }
        );
      } else {
        document.getElementById('status').textContent = "Geolocation not supported.";
      }
    };
  </script>
</body>
</html>
